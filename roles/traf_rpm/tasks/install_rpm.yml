- name: Install epel repo if not exists
  copy: src=epel.repo dest=/etc/yum.repos.d/ force=no
  become: yes
  when: ansible_os_family == 'RedHat' or ansible_os_family == 'CentOS'

- name: Copy trafodion RPM to all nodes
  copy: src={{ traf_rpm }} dest=/tmp/ force=yes

- name: Get RPM full name
  shell: "echo {{ traf_rpm }} | awk -F/ '{print $NF}'"
  register: fullname

- name: Set RPM name variable
  set_fact:
    rpm_name: "{{ fullname.stdout }}"
    
- name: Install trafodion RPM - CentOS
  yum: name="/tmp/{{ rpm_name }}" state=present
  become: yes
  register: rpm_installed
  when: ansible_os_family == 'RedHat' or ansible_os_family == 'CentOS'

- name: Install trafodion RPM - SuSE
  zypper: name="/tmp/{{ rpm_name }}" state=present
  become: yes
  register: rpm_installed_suse
  when: ansible_os_family == 'Suse'

- name: Reinstall trafodion RPM if already installed - CentOS
  shell: "rpm -i /tmp/{{ rpm_name }} --force"
  when: (ansible_os_family == 'RedHat' or ansible_os_family == 'CentOS') and rpm_installed.changed==False
  become: yes

- name: Reinstall trafodion RPM if already installed - SuSE
  shell: "rpm -i /tmp/{{ rpm_name }} --force"
  when: ansible_os_family == 'SuSE' and rpm_installed_suse.changed==False
  become: yes

- name: Create trafodion user if not exists
  user: name=trafodion shell=/bin/bash groups=trafodion
  become: yes

- name: Get RPM location
  shell: "rpm -ql {{ rpm_basename }} |head -1"
  register: traf_loc
    
- name: Get RPM version
  shell: "echo {{ traf_loc.stdout }} | sed -r 's/.*-(.*)/\\1/g'"
  register: traf_version
  when: traf_loc|success

- name: Set sqroot and traf_ver variables
  set_fact:
    sq_root: "{{ traf_loc.stdout }}"
    traf_ver: "{{ traf_version.stdout }}"
  when: traf_version|success
